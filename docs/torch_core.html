---

title: torch_core
keywords: 
sidebar: home_sidebar

summary: "Basic functions using pytorch"
---

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="torch_core">torch_core<a class="anchor-link" href="#torch_core">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This module contains all the basic functions we need in other modules of the fastai library (split with <a href="/core#core"><code>core</code></a> that contains the ones not requiring pytorch). Its documentation can easily be skipped at a first read, unless you want to know what a given fuction does.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Global-constants">Global constants<a class="anchor-link" href="#Global-constants">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>AdamW = partial(optim.Adam, betas=(0.9,0.99))</code> <div style="text-align: right"><a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L43">[source]</a></div></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>bn_types = (nn.BatchNorm1d, nn.BatchNorm2d, nn.BatchNorm3d)</code> <div style="text-align: right"><a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L41">[source]</a></div></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>default_device = torch.device('cuda') if torch.cuda.is_available() else torch.device('cpu')</code> <div style="text-align: right"><a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L42">[source]</a></div></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Functions-that-operate-conversions">Functions that operate conversions<a class="anchor-link" href="#Functions-that-operate-conversions">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=flatten></a><code>flatten</code></h4>
<blockquote><p><code>flatten</code>(<code>m</code>)
<a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L117">[source]</a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Flattens all the layers of <code>m</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=model2half></a><code>model2half</code></h4>
<blockquote><p><code>model2half</code>(<code>model</code>:<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>) → <a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a></p>
</blockquote>
<p>Convert <code>model</code> to half precision except the batchnorm layers.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L168">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=requires_grad></a><code>requires_grad</code></h4>
<blockquote><p><code>requires_grad</code>(<code>m</code>:<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>, <code>b</code>:<code>Optional</code>[<code>bool</code>]=<code>None</code>) → <code>Optional</code>[<code>bool</code>]
<a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L93">[source]</a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If <code>b</code> is None, returns the <a href="/torch_core#requires_grad"><code>requires_grad</code></a> state of the first layer of <code>m</code>. Otherwise, sets <code>requires_grad=b</code> in all children of <code>m</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=tensor></a><code>tensor</code></h4>
<blockquote><p><code>tensor</code>(<code>x</code>:<code>Any</code>) → <code>Tensor</code></p>
</blockquote>
<p>Like <code>torch.as_tensor</code>, but handle lists too  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L65">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ensures <code>x</code> is a torch <code>Tensor</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=to_data></a><code>to_data</code></h4>
<blockquote><p><code>to_data</code>(<code>b</code>:<code>ItemsList</code>)</p>
</blockquote>
<p>Recursively map lists of items in <code>b</code> to their wrapped data  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L78">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=to_detach></a><code>to_detach</code></h4>
<blockquote><p><code>to_detach</code>(<code>b</code>:<code>Tensors</code>)</p>
</blockquote>
<p>Recursively detach lists of tensors in <code>b</code>  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L73">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=to_device></a><code>to_device</code></h4>
<blockquote><p><code>to_device</code>(<code>b</code>:<code>Tensors</code>, <code>device</code>:<a href="https://pytorch.org/docs/stable/tensor_attributes.html#torch-device"><code>device</code></a>)</p>
</blockquote>
<p>Ensure <code>b</code> is on <code>device</code>.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L83">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=to_half></a><code>to_half</code></h4>
<blockquote><p><code>to_half</code>(<code>b</code>:<code>Collection</code>[<code>Tensor</code>]) → <code>Collection</code>[<code>Tensor</code>]
<a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L158">[source]</a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Put the input of the batch <code>b</code> in half precision.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=to_np></a><code>to_np</code></h4>
<blockquote><p><code>to_np</code>(<code>x</code>)
<a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L200">[source]</a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Convert <code>x</code> to a numpy array.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Functions-to-deal-with-model-initialization">Functions to deal with model initialization<a class="anchor-link" href="#Functions-to-deal-with-model-initialization">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=apply_init></a><code>apply_init</code></h4>
<blockquote><p><code>apply_init</code>(<code>m</code>, <code>init_func</code>:<code>LayerFunc</code>)</p>
</blockquote>
<p>Initialize all non-batchnorm layers of <code>m</code> with <code>init_func</code>.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L184">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=apply_leaf></a><code>apply_leaf</code></h4>
<blockquote><p><code>apply_leaf</code>(<code>m</code>:<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>, <code>f</code>:<code>LayerFunc</code>)</p>
</blockquote>
<p>Apply <code>f</code> to children of <code>m</code>.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L178">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=cond_init></a><code>cond_init</code></h4>
<blockquote><p><code>cond_init</code>(<code>m</code>:<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>, <code>init_func</code>:<code>LayerFunc</code>)</p>
</blockquote>
<p>Initialize the non-batchnorm layers of <code>m</code> with <code>init_func</code>  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L172">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=in_channels></a><code>in_channels</code></h4>
<blockquote><p><code>in_channels</code>(<code>m</code>:<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>) → <code>List</code>[<code>int</code>]</p>
</blockquote>
<p>Return the shape of the first weight layer in <code>m</code>.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L188">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Function-that-deal-get-informations-on-a-Model">Function that deal get informations on a Model<a class="anchor-link" href="#Function-that-deal-get-informations-on-a-Model">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=children></a><code>children</code></h4>
<blockquote><p><code>children</code>(<code>m</code>:<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>) → <code>ModuleList</code></p>
</blockquote>
<p>Get children of module <code>m</code>.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L105">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=first_layer></a><code>first_layer</code></h4>
<blockquote><p><code>first_layer</code>(<code>m</code>:<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>) → <a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a></p>
</blockquote>
<p>Retrieve first layer in a module <code>m</code>.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L118">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=num_children></a><code>num_children</code></h4>
<blockquote><p><code>num_children</code>(<code>m</code>:<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>) → <code>int</code></p>
</blockquote>
<p>Get number of children modules in module <code>m</code>.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L109">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=range_children></a><code>range_children</code></h4>
<blockquote><p><code>range_children</code>(<code>m</code>:<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>) → <code>Iterator</code>[<code>int</code>]</p>
</blockquote>
<p>Return iterator of len of children of <code>m</code>.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L113">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=trainable_params></a><code>trainable_params</code></h4>
<blockquote><p><code>trainable_params</code>(<code>m</code>:<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>) → <code>ParamList</code></p>
</blockquote>
<p>Return list of trainable params in <code>m</code>.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L100">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Functions-to-deal-with-BatchNorm-layers">Functions to deal with BatchNorm layers<a class="anchor-link" href="#Functions-to-deal-with-BatchNorm-layers">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=bn2float></a><code>bn2float</code></h4>
<blockquote><p><code>bn2float</code>(<code>module</code>:<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>) → <a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a></p>
</blockquote>
<p>If <code>module</code> is batchnorm don't use half precision.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L162">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=set_bn_eval></a><code>set_bn_eval</code></h4>
<blockquote><p><code>set_bn_eval</code>(<code>m</code>:<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>)</p>
</blockquote>
<p>Set bn layers in eval mode for all recursive children of <code>m</code>.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L151">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=split_bn_bias></a><code>split_bn_bias</code></h4>
<blockquote><p><code>split_bn_bias</code>(<code>layer_groups</code>:<code>ModuleList</code>) → <code>ModuleList</code></p>
</blockquote>
<p>Sort each layer in  <code>layer_groups</code> into batchnorm (<code>bn_types</code>) and non-batchnorm groups.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L140">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Other-functions">Other functions<a class="anchor-link" href="#Other-functions">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=calc_loss></a><code>calc_loss</code></h4>
<blockquote><p><code>calc_loss</code>(<code>y_pred</code>:<code>Tensor</code>, <code>y_true</code>:<code>Tensor</code>, <code>loss_class</code>:<code>type</code>=<code>'CrossEntropyLoss'</code>, <code>bs</code>=<code>64</code>)</p>
</blockquote>
<p>Calculate loss between <code>y_pred</code> and <code>y_true</code> using <code>loss_class</code> and <code>bs</code>.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L194">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=data_collate></a><code>data_collate</code></h4>
<blockquote><p><code>data_collate</code>(<code>batch</code>:<code>ItemsList</code>) → <code>Tensor</code></p>
</blockquote>
<p>Convert <code>batch</code> items to tensor data.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L89">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=split_model></a><code>split_model</code></h4>
<blockquote><p><code>split_model</code>(<code>model</code>:<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>, <code>splits</code>:<code>Collection</code>[<code>Union</code>[<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>, <code>ModuleList</code>]], <code>want_idxs</code>:<code>bool</code>=<code>False</code>)
<a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L129">[source]</a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Splits the <code>model</code> according to the layer in <code>splits</code>. If <code>splits</code> are layers, the model is split at those (not included) sequentially. If <code>want_idxs</code> is True, the corresponding indexes are returned. If <code>splits</code> are lists of layers, the model is split according to those.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4><a id=split_model_idx></a><code>split_model_idx</code></h4>
<blockquote><p><code>split_model_idx</code>(<code>model</code>:<a href="https://pytorch.org/docs/stable/nn#torch.nn.Module"><code>Module</code></a>, <code>idxs</code>:<code>Collection</code>[<code>int</code>]) → <code>ModuleList</code></p>
</blockquote>
<p>Split <code>model</code> according to the indices in <code>idxs</code>.  <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_core.py#L122">[source]</a></p>

</div>

</div>

</div>
</div>

</div>
</div>
 

